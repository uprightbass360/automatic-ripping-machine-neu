# Split deployment: ARM + UI on this machine, Transcoder on a remote host.
# The transcoder runs its own docker-compose from the arm-transcoder repo.
# Copy .env.remote-transcoder.example to .env and adjust values before starting.

services:
  # Fix ownership on the shared DB volume before ARM starts
  arm-db-init:
    image: alpine
    container_name: arm-db-init
    volumes:
      - arm-db:/data/db
    command: chown -R ${ARM_UID:-1000}:${ARM_GID:-1000} /data/db
    restart: "no"

  # Dump HandBrake built-in presets to JSON for the UI settings page
  arm-hb-presets:
    build: .
    image: uprightbass360/automatic-ripping-machine:${ARM_VERSION:-latest}
    container_name: arm-hb-presets
    volumes:
      - hb-presets:/data/hb-presets
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        HandBrakeCLI --preset-list 2>&1 | python3 -c "
        import json, sys, re
        names = []
        for line in sys.stdin:
            m = re.match(r'^    (\S.+)$', line.rstrip())
            if m:
                name = m.group(1)
                if not any(c in name for c in ['/', ':', '(']):
                    names.append(name)
        json.dump(sorted(set(names)), open('/data/hb-presets/presets.json', 'w'), indent=2)
        print(f'Wrote {len(names)} HandBrake presets')
        "
    restart: "no"

  # ARM ripper â€” creates the database on first startup
  arm-rippers:
    build: .
    image: uprightbass360/automatic-ripping-machine:${ARM_VERSION:-latest}
    container_name: arm-rippers
    restart: always
    privileged: true
    ports:
      - "${ARM_PORT:-8080}:8080"
    environment:
      - ARM_UID=${ARM_UID}
      - ARM_GID=${ARM_GID}
      - TZ=${TZ}
    volumes:
      - ${ARM_MUSIC_PATH}:/home/arm/music
      - ${ARM_LOGS_PATH}:/home/arm/logs
      - ${ARM_MEDIA_PATH}:/home/arm/media
      - ${ARM_CONFIG_PATH}:/etc/arm/config
      - arm-db:/home/arm/db
    devices:
      - ${ARM_DEVICE_0:-/dev/sr0}:/dev/sr0
      - ${ARM_DEVICE_1:-/dev/sr1}:/dev/sr1
      # - ${ARM_DEVICE_2:-/dev/sr2}:/dev/sr2
      # - ${ARM_DEVICE_3:-/dev/sr3}:/dev/sr3
    cpuset: ${ARM_CPUSET:-2,3,4,5,6,7}
    depends_on:
      arm-db-init:
        condition: service_completed_successfully

  # Replacement dashboard (SvelteKit + FastAPI)
  arm-ui:
    image: uprightbass360/arm-ui:${UI_VERSION:-latest}
    container_name: arm-ui
    restart: unless-stopped
    ports:
      - "${UI_PORT:-8888}:8888"
    environment:
      - ARM_UI_ARM_DB_PATH=/data/db/arm.db
      - ARM_UI_ARM_LOG_PATH=/data/logs
      - ARM_UI_ARM_CONFIG_PATH=/data/arm-config/arm.yaml
      - ARM_UI_ARM_URL=http://arm-rippers:8080
      - ARM_UI_TRANSCODER_URL=http://${TRANSCODER_HOST}:${TRANSCODER_PORT:-5000}
      - ARM_UI_ARM_HB_PRESETS_PATH=/data/hb-presets/presets.json
      - ARM_UI_TRANSCODER_API_KEY=${TRANSCODER_API_KEY:-}
    volumes:
      - arm-db:/data/db:ro
      - ${ARM_LOGS_PATH}:/data/logs:ro
      - ${ARM_CONFIG_PATH}:/data/arm-config:rw
      - hb-presets:/data/hb-presets:ro
    depends_on:
      arm-rippers:
        condition: service_healthy
      arm-hb-presets:
        condition: service_completed_successfully

volumes:
  arm-db:
  hb-presets:
